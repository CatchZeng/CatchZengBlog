---
layout:     post
title:      "ARKit浅析篇"
subtitle:   "iOS开发"
date:       2017-06-14 09:38:27
author:     "CatchZeng"
header-img: "img/post-bg-2015.jpg"
tags:
    - iOS
---
<span id="busuanzi_container_page_pv"></span>

在上一篇[ARKit体验篇](http://catchzeng.com/2017/06/13/ARKit体验篇/)中我们体验了ARKit，这一篇主要从类出发分析下ARKit的流程。

## ARKit浅析
我们知道，iOS的视图显示层级为UIWindow -》UIViewController -》UIView。UIView的作用是将视图显示在UIWindow中,AR呈现的东西也属于视图，所以我们可以大胆假设AR的呈现也是基于UIView的。由此假设，我们看下上一篇的Demo源码
```
  //在界面上创建ARSCNView，用于展示AR
 @IBOutlet var sceneView: ARSCNView!
```
可以看到，AR由ARSCNView呈现出来，查看文档可以看到[ARSCNView](https://developer.apple.com/documentation/arkit/arscnview)继承于[SCNView](https://developer.apple.com/documentation/scenekit/scnview)。而SCNView则是[SceneKit](https://developer.apple.com/documentation/scenekit)中一个继承于UIView的类。
```
@available(iOS 11.0, *)
open class ARSCNView : SCNView {
```
[SCNView](https://developer.apple.com/documentation/scenekit/scnview)负责显示一个3D场景，ARSCNView在SCNView的基础上，加入了[ARSession](https://developer.apple.com/documentation/arkit/arsession)使得其可以用摄像头([ARCamera](https://developer.apple.com/documentation/arkit/arcamera))捕捉到的现实世界图像构成3D场景，也就是AR。

![ARKit](http://upload-images.jianshu.io/upload_images/943491-ecf16187b749b8a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## ARSession
查看[文档](https://developer.apple.com/documentation/arkit/arsession)，不难看出ARSession是沟通摄像头(ARCamera)和运动处理的桥梁。ARCamera负责捕捉摄像头画面，ARSession负责搭建3D场景。

![ARSession](http://upload-images.jianshu.io/upload_images/943491-90c48ba66b8751ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

运行ARSession需要指定一个[ARSessionConfiguration](https://developer.apple.com/documentation/arkit/arsessionconfiguration)来负责追踪相机在3D世界中的位置以及场景的捕捉（例如平面）。
ARSessionConfiguration是一个父类，为了更好的看到增强现实的效果，苹果为我们提供了它的子类[ARWorldTrackingSessionConfiguration](https://developer.apple.com/documentation/arkit/arworldtrackingsessionconfiguration)来便于使用。

![ARSessionConfiguration](http://upload-images.jianshu.io/upload_images/943491-0176e0636dd1fdf9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![ARWorldTrackingSessionConfiguration](http://upload-images.jianshu.io/upload_images/943491-aa2f01e187dedee3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

细心的朋友可以看到文档中有个isSupported方法应该就是为什么ARKit要求A9芯片以上的原因了（猜的，不准勿喷），所以，***使用ARKit时别忘了做这个判断***。
![isSupported](http://upload-images.jianshu.io/upload_images/943491-635dfadf320ca5fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ARWorldTrackingSessionConfiguration计算出相机在3D世界中的位置[ARFrame](https://developer.apple.com/documentation/arkit/ARFrame)后，将其交给ARSession去管理

![ARFrame](http://upload-images.jianshu.io/upload_images/943491-9f5327bc022e762d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

我们理清了如何从相机捕捉图像到手机上显示3D场景，而虚拟的物体部分是由节点[SCNNode](https://developer.apple.com/documentation/scenekit/scnnode)构成的（节点构成了场景SCNScene,无数个场景构成了3D世界)

## ARKit流程
* ARSCNView加载SCNScene
* SCNScene启动ARCamera捕捉图像
* ARSCNView将SCNScene的数据交给Session
* Session通过管理ARSessionConfiguration实现场景追踪并且返回一个ARFrame（添加3D物体模型的时候计算出3D物体模型相对于相机的真实的矩阵位置需要使用到）
* 往SCNScene中添加一个3D物体（SCNNode）

![ARKit](http://upload-images.jianshu.io/upload_images/943491-990530b6eba9202a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 总结

本篇主要分析了ARKit的流程，让大家对ARKit的几个主要类以及职责先有一个初步了解。下一篇开始将以实例来一步步探索ARKit。